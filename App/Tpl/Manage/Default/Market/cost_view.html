<include file="Public:header" />
<include file="Public:viewmedia" />

<div class="container">
    <div class="page-header">
        <h4><a name="tab">客户服务详情</a><span style="font-size: medium;color: #0088cc;"> - {$market['idcode']} - {$market['category_name']} - {$market['customer_id']|customer_show_html=###, false}</span></h4>
    </div>
    <include file="Public:alert"/>
    <div class="tabbable">
        <include file="tabnav"/>
    </div>
    <div class="row-fluid">
        <div class="tabbable span12">
            <div class="tab-content">
                <table class="table table-hover">
                    <thead >
                    <tr>
                        <td colspan="4">
                            <p style="font-size: 14px;">
                                <if condition="$market_settle">
                                    <a href="{:U('market/settlement', 'id='.$market['market_id'])}" class="settlement_btn barrier-submit">结算</a> |
                                <else/>
                                    <a style="color: #D0D0D0;cursor: no-drop;" href="javascript:void(0);">结算</a> |

                                </if>
                                <if condition="$market['settle_state'] eq '917'">
                                    <a href="javascript:void(0);" onclick="return cancel_confirm();">退回</a> |
                                <else/>
                                    <a style="color: #D0D0D0;cursor: no-drop;" href="javascript:void(0);">退回</a> |
                                </if>
                            </p>
                        </td>
                    </tr>
                    </thead>

                </table>

                <table class="table table-hover">

                    <tbody>
                    <tr>
                        <th colspan="4"> 结算信息 </th>
                    </tr>
                    <tr>
                        <td class="tdleft" width="15%">结算状态:</td>
                        <td width="35%">{$market['settle_state']|format_market_status}</td>
                        <td class="tdleft" width="15%">订单金额:</td>
                        <td width="35%">{$market['sum_settle_price']}</td>
                    </tr>
                    <tr>
                        <td class="tdleft" width="15%">已付金额:</td>
                        <td width="35%">{$market['deficit_price']}</td>
                        <td class="tdleft" width="15%">待确认金额:</td>
                        <td width="35%">{$market['wait_confirm_price']}</td>
                    </tr>
                    <tr>
                        <td class="tdleft" width="15%">未付金额:</td>
                        <td width="35%">{$market['surplus_price']}</td>
                        <td class="tdleft" width="16%">已冻结金额:</td>
                        <td width="35%">
                            {$market['customer_earnest']}
                        </td>
                    </tr>

                    <tr>
                        <th colspan="4"> 雇员工资 </th>
                    </tr>
                    <tr>
                    <td colspan="4">
                        <table class="table cost-datatables  compact" cellspacing="0" width="100%">
                            <thead>
                            <tr>
                                <th style="width: 200px">雇员</th>
                                <th style="width: 200px">工资</th>
                                <th style="width: 200px">比例</th>
                                <th>状态</th>
                            </tr>
                            </thead>
                            <tbody>
                            <volist name="proudct_salary_list" id="vo">
                            <tr>
                                <td>
                                    <a href="{:U('product/view', 'id='.$vo['product_id'])}" target="_blank">
                                    {$vo['product_name_show']}
                                    </a>
                                </td>

                                <td>
                                    {$vo['salary']|number_format=###,2}
                                </td>

                                <td>
                                    {$vo['agency_scale']|number_format=###,2}
                                </td>
                                <td>
                                    <if condition="$vo['salary'] gt 0">
                                    <if condition="$vo['acc_salary'] egt $vo['salary']">
                                        已支付
                                    <elseif condition="$vo['acc_salary'] eq 0"/>
                                        未支付
                                    <else/>
                                        未付清[{$vo['salary'] - $vo['acc_salary']}]
                                    </if>
                                    </if>
                                </td>

                            </tr>
                            </volist>

                            </tbody>
                            <tfoot>
                            <tr>
                                <th colspan="4">合计: {$market['sum_salary']}</th>
                            </tr>
                            <tr>
                                <th colspan="4" style="color: red">中介费: {$market['sum_agency']}</th>
                            </tr>
                            <tr>
                                <td colspan="4" >
                                    <volist name="product_salary_account_list" id="vo">
                                        <p <eq name="vo.quarry" value="1">style="background-color:#e2e2e2"</eq>>
                                            [{$vo['create_time']|toDate}]  {$vo['product_id']|product_show_html=###, false, 'account'} {$vo['income_or_expenses']|acction_type_desc} {$vo['name']}， 金额为 {$vo['money']}
                                        </p>
                                    </p>
                                    </volist>
                                </td>
                            </tr>
                            </tfoot>
                        </table>
                    </td>

                    </tr>


                    <tr>
                        <th colspan="3"> 渠道费 </th>
                        <th style="text-align: right">
                            <if condition="($market['settle_state'] eq '918') or ($market['status_id'] == '0')">
                                <a style="color: #D0D0D0;cursor: no-drop;" href="javascript:void(0);">增加</a>
                            <else/>
                                <a href="{:U('market/channel_add', 'id='.$market['market_id'])}&refer_add_url={$Think.Server.REQUEST_URI|urlencode}">增加</a>
                            </if>
                        </th>
                    </tr>
                    <tr>
                        <td colspan="4">
                            <table class="table cost-datatables  compact" cellspacing="0" width="100%">
                                <thead>
                                <tr>
                                    <th style="width: 200px">渠道</th>
                                    <th style="width: 200px">渠道人</th>
                                    <th style="width: 200px">渠道费</th>
                                    <th>状态</th>
                                    <th style="width: 100px">操作</th>

                                </tr>
                                </thead>
                                <tbody>
                                <volist name="channel_list" id="vo">
                                    <tr>
                                        <td>
                                            {$vo['channel_name']}
                                        </td>
                                        <td>
                                            {$vo['channel_role_name']}
                                        </td>
                                        <td>
                                            {$vo['channel_price']|number_format=###,2}
                                        </td>
                                        <td>

                                        <if condition="$vo['channel_price'] gt 0">
                                        <if condition="$vo['channel_price_settle_time'] gt 0">
                                            已支付
                                        <else/>
                                            未支付
                                        </if>
                                            </if>
                                        </td>
                                        <td>
                                            <if condition="($market['settle_state'] eq '918')  or $market['status_id'] == '0'">
                                                <a style="color: #D0D0D0;cursor: no-drop;" href="javascript:void(0);">编辑</a>
                                                <a style="color: #D0D0D0;cursor: no-drop;" href="javascript:void(0);">删除</a>

                                                <else/>
                                                <a href="{:U('market/channel_edit')}&id={$vo['market_channel_id']}&market_id={$market.market_id}&refer_add_url={$Think.Server.REQUEST_URI|urlencode}">编辑</a>
                                                <a  href="{:U('market/channel_delete')}&id={$vo['market_channel_id']}&market_id={$market.market_id}" class="del_confirm">删除</a>

                                            </if>
                                        </td>
                                    </tr>
                                </volist>

                                </tbody>
                                <tfoot>
                                <tr>
                                    <th colspan="5">合计: {$market['sum_channel_price']}</th>

                                </tr>
                                <tr>
                                    <th colspan="5" style="color: red">利润:  {$market['gain']}</th>

                                </tr>
                                <tr>
                                    <td colspan="5" >
                                        <volist name="channel_account_list" id="vo">
                                            <p <eq name="vo.quarry" value="1">style="background-color:#e2e2e2"</eq>>
                                                [{$vo['create_time']|toDate}]  {:model_info_show_html($vo['account_type'], $vo['clause_additive'], 'account')}  {$vo['income_or_expenses']|acction_type_desc} {$vo['name']}， 金额为 {$vo['money']}
                                            </p>
                                            </p>
                                        </volist>
                                    </td>
                                </tr>
                                </tfoot>
                            </table>
                        </td>
                    </tr>

                    <if condition="$proudct_reward_list">
                    <tr>
                        <th colspan="3"> 奖励 </th>
                        <th style="text-align: right">
                        </th>
                    </tr>
                    <tr>
                        <td colspan="4">
                            <table class="table cost-datatables  compact" cellspacing="0" width="100%">
                                <thead>
                                <tr>
                                    <th style="width: 200px">类型</th>
                                    <th style="width: 200px">渠道人</th>
                                    <th style="width: 200px">金额</th>
                                    <th>状态</th>
                                    <th style="width: 100px">操作</th>
                                </tr>
                                </thead>
                                <tbody>
                                <volist name="proudct_reward_list" id="vo">
                                    <tr>
                                        <td>
                                            渠道奖励
                                        </td>
                                        <td>
                                            {:channel_model_role_show_html($vo["channel_role_model"], $vo['channel_role_id'], true)}
                                        </td>
                                        <td>
                                            {$vo['urge_reward_price']|number_format=###,2}
                                        </td>
                                        <td>
                                            <if condition="($vo['urge_reward_settle_time'] gt 0)">
                                                已支付
                                            <else/>
                                                未支付
                                            </if>
                                        </td>
                                        <td>
                                            <if condition="($market['settle_state'] eq '918')  or $market['status_id'] == '0'">
                                                <a style="color: #D0D0D0;cursor: no-drop;" href="javascript:void(0);">编辑</a>
                                            <else/>
                                                <a href="{:U('market/reward_edit')}&rweard_type=urge&id={$vo['market_product_id']}&market_id={$market.market_id}&refer_add_url={$Think.Server.REQUEST_URI|urlencode}">编辑</a>

                                            </if>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            建档奖励
                                        </td>
                                        <td>
                                            {:channel_model_role_show_html($vo["channel_role_model"], $vo['channel_role_id'], true)}
                                        </td>
                                        <td>
                                            {$vo['channel_reward_price']|number_format=###,2}
                                        </td>
                                        <td>
                                            <if condition="($vo['channel_reward_settle_time'] gt 0)">
                                                已支付
                                                <else/>
                                                未支付
                                            </if>
                                        </td>
                                        <td>
                                            <if condition="($market['settle_state'] eq '918')  or $market['status_id'] == '0'">
                                                <a style="color: #D0D0D0;cursor: no-drop;" href="javascript:void(0);">编辑</a>

                                                <else/>
                                                <a href="{:U('market/reward_edit')}&rweard_type=channel&id={$vo['market_product_id']}&market_id={$market.market_id}&refer_add_url={$Think.Server.REQUEST_URI|urlencode}">编辑</a>

                                            </if>
                                        </td>
                                    </tr>
                                </volist>

                                </tbody>
                                <tfoot>
                                <tr>
                                    <th colspan="5">合计: {$market['sum_reward_price']}</th>

                                </tr>
                                <tr>
                                    <td colspan="5" >
                                        <volist name="reward_account_list" id="vo">
                                            <p <eq name="vo.quarry" value="1">style="background-color:#e2e2e2"</eq>>
                                            [{$vo['create_time']|toDate}]  {:model_info_show_html($vo['account_type'], $vo['clause_additive'], 'account')}  {$vo['income_or_expenses']|acction_type_desc} {$vo['name']}， 金额为 {$vo['money']}
                                            </p>
                                            </p>
                                        </volist>
                                    </td>
                                </tr>
                                </tfoot>
                            </table>
                        </td>
                    </tr>
                    </if>
                    <tr>
                        <th colspan="3">
                            促单费
                        </th>
                        <th style="text-align: right">
                            <if condition="($market['settle_state'] eq '918')  or ($market['status_id'] == '0')">
                                <a style="color: #D0D0D0;cursor: no-drop;" href="javascript:void(0);">增加</a>
                            <else/>
                                <a href="{:U('market/urge_add', 'id='.$market['market_id'])}&refer_add_url={$Think.Server.REQUEST_URI|urlencode}">增加</a>
                            </if>
                        </th>
                    </tr>
                    <tr>
                        <td colspan="4">
                            <table class="table cost-datatables  compact" cellspacing="0" width="100%">
                                <thead>
                                <tr>
                                    <th style="width: 200px">促单人</th>
                                    <th style="width: 200px">促单费</th>
                                    <th style="width: 200px">比例</th>
                                    <th>状态</th>
                                    <th style="width: 100px">操作</th>

                                </tr>
                                </thead>
                                <tbody>
                                <volist name="urge_list" id="vo">
                                    <tr>
                                        <td>
                                            {$vo['urge_role_id']|staff_role_show_html}
                                        </td>
                                        <td>
                                            {$vo['urge_price']|number_format=###,2}
                                        </td>
                                        <td>
                                            {$vo['urge_branch_ratio']|number_format=###,2}
                                        </td>
                                        <td>
                                            <if condition="$vo['urge_price_settle_time'] gt 0">
                                            <if condition="$vo['urge_price_settle_time'] gt 0">
                                                已支付
                                            <else/>
                                                未支付
                                            </if>
                                            </if>
                                        </td>
                                        <td>
                                            <if condition="($market['settle_state'] eq '918') or ($market['status_id'] == '0') or ($lock_agency_scale eq true)">
                                                <a style="color: #D0D0D0;cursor: no-drop;" href="javascript:void(0);">编辑</a>
                                                <a style="color: #D0D0D0;cursor: no-drop;" href="javascript:void(0);">删除</a>
                                            <else/>
                                                <a href="{:U('market/urge_edit')}&id={$vo['market_urge_id']}&market_id={$market.market_id}&refer_add_url={$Think.Server.REQUEST_URI|urlencode}">编辑</a>
                                                <a  href="{:U('market/urge_delete')}&id={$vo['market_urge_id']}&market_id={$market.market_id}" class="del_confirm">删除</a>
                                            </if>
                                        </td>
                                    </tr>
                                </volist>

                                </tbody>
                                <tfoot>
                                <tr>
                                    <th colspan="5">合计: {$market['sum_urge_price']}</th>

                                </tr>
                                <tr>
                                    <th colspan="5" style="color: red">净利润:  {$market['profit']}</th>

                                </tr>
                                <tr>
                                    <td colspan="5" >
                                        <volist name="urge_account_list" id="vo">
                                            <p <eq name="vo.quarry" value="1">style="background-color:#e2e2e2"</eq>>
                                                [{$vo['create_time']|toDate}]  {:model_info_show_html($vo['account_type'], $vo['clause_additive'], 'account')}  {$vo['income_or_expenses']|acction_type_desc} {$vo['name']}， 金额为 {$vo['money']}
                                            </p>
                                            </p>
                                        </volist>
                                    </td>
                                </tr>
                                </tfoot>
                            </table>
                        </td>

                    </tr>

                    </tbody>
                </table>

            </div>
        </div>
    </div>
</div>

<script>
    function cancel_confirm() {
        var dialog = art.dialog({
            id: 'N3690',
            title: "退回确认",
            lock:true,
            fixed:true,
            ok: function () {
                if ($('#content').val() == "") {
                    alert("必须写明退回原因");
                    return false;
                }
                show_lock_tips("正在退回结算...");
                $('#cancel_submit_form').submit();
            },
            cancel: true
        });
        $.ajax({
            url: "{:U('Market/cancel_submit', 'id='.$market['market_id'])}",
            success: function (data) {
                dialog.content(data);
            },
            cache: false
        });
        return false;
    }

    $(".settlement_btn").click(function(){
        var href = $(this).attr("href");
        art.dialog.confirm('确实要结算订单吗', function(){
            show_lock_tips("正在提交结算...");
            window.location.replace(href);
        });
        return false;
    });

</script>


<script>

    $(document).ready(function() {
        var table = $('.cost-datatables').DataTable( {
            'searching':false,
            'paging':false,
            'language': def_dataTable_lang_opt,
        } );

        $('.cost-datatables tbody').on('click', 'td.details-control', function () {
            var tr = $(this).closest('tr');
            var row = table.row( tr );

            if ( row.child.isShown() ) {
                row.child.hide();
                tr.removeClass('shown');
            }
            else {
                row.child($("#channel-info-tmpl").tmpl(row.data())).show();
                tr.addClass('shown');
            }
        } );
        $(".dataTables_info").hide();
    } );

</script>

<include file="Public:footer" />	