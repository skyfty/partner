<include file="Public:header" />

<div class="container">
	<!-- Docs nav ================================================== -->
	<div class="page-header">
		<h4>{:L('ADD_THE_BUSINESS_OPPORTUNITIES')}</h4>
	</div>
	<div class="row-fluid">
		<div class="span12">
			<include file="Public:alert"/>
			<form id="form1" action="{:U('')}" method="post"  enctype="multipart/form-data">
			    <input type="hidden" name="refer_url" value="{$refer_url}"/>
				<input type="hidden" name="creator_id" value="{$_SESSION.user_id}"/>
                <input type="hidden" name="m" value="market"/>
                <input type="hidden" name="a" value="add"/>
				<if condition="ACTION_NAME== 'renewal'">
					<input type="hidden" name="renewal_market_id" id="renewal_market_id" value="{$renewal_market_id}"/>
				</if>
				<table class="table table-hover">
					<thead>
					<tr>
						<td style="text-align: center" colspan="4">
							<input name="submit" class="btn btn-primary" type="submit" value="{:L('SAVE')}"/> &nbsp;
							<input class="btn" type="reset" onclick="on_click_return();" value="{:L('RETURN')}"/>
						</td>
					</tr>
					</thead>
					<tfoot>
					<tr>
						<td style="text-align: center" colspan="4">
							<input name="submit" class="btn btn-primary" type="submit" value="{:L('SAVE')}"/> &nbsp;
							<input class="btn" type="reset" onclick="on_click_return();" value="{:L('RETURN')}"/>
						</td>
					</tr>
					</tfoot>
					<tbody>
					<volist name="fields_group" id="gvo">
						<tr><th colspan="4">{$gvo.name}</th></tr>
						<php>$j=0;</php>
						<volist name="gvo['fields']" id="vo">
							<if condition="$vo['operating'] != '4'">
								<php>$j++;</php>
								<if condition="$vo['one_row'] == '1' or $vo['form_type'] == 'textarea' or $vo['form_type'] == 'editor' or $vo['form_type'] == 'address'">
									<if condition="$i%2 == 0">
										<td colspan="2">&nbsp;</td>
										</tr>
									</if>
									<tr>
										<td class="tdleft" width="15%">{$vo.name}:</td>
										<td colspan="3" id="{$vo['model']}_{$vo['field']}_{$vo['is_main']}_html">{$vo.html}</td>
									</tr>
									<if condition="$i%2 != 0 && count($gvo['fields']) != $j">
										<php>$i++;</php>
									</if>
									<else/>
									<if condition="$i%2 != 0">
										<tr>
									</if>
									<td class="tdleft" width="15%">
											{$vo.name}:
									</td>
									<td width="35%" id="{$vo['model']}_{$vo['field']}_{$vo['is_main']}_html">
										{$vo.html}

										<if condition="$vo['field'] == 'customer_id'">
											<a id="quick_create_customer" onclick="return on_click_quick_create_customer();" href="javascript:void(0);" >创建客户</a>
										</if>
									</td>
									<if condition="$i%2 == 0">
										</tr>
									</if>
									<if condition="$i%2 != 0 && count($gvo['fields']) == $j">
										<td colspan="2">&nbsp;</td>
										</tr>
									</if>
								</if>
							</if>
						</volist>
					</volist>
					</tbody>
				</table>

				<script>
					function on_click_return() {
					<if condition="$refer_url neq ''">
								location.assign('{$refer_url}');
					<else/>
						if (window.history.length == 0) {
							window.opener=null;
							window.open('','_self');
							window.close();
						} else {
							window.history.back();
						}
					</if>
					}
				</script>
            </form>

		</div>

	</div>
</div>

<include file="Customer:selectDialog" />
<script type="text/javascript">
    function on_customer_info(b) {
        $('#customer_name').val(b.name);
        $('#customer_id').val(b.customer_id);
    }
    $('#customer_name').click(function(){
		var param = {};
		select_customer(param);
	});
</script>

<script>
    var branch_config = null;
    function on_branch_config_change() {
        if (!branch_config) {
            return;
        }
        var category_id =  $('#category_id').val();
        $('#agency_scale').val(branch_config[category_id]['agency_scale']);
    }

    function on_category_branch_change() {
        var branch_id = $('#branch_id').val();
        var url = "{:U('branch/get_category_config', 'id=')}" + branch_id;
        $.ajax({ url: url,
            success: function (data) {
                if (data) {
                    branch_config = data;
                    on_branch_config_change();
                }
            },
            cache: false
        });
    }

    $('#category_id').change(on_category_branch_change);
    $('#branch_id').change(on_category_branch_change);

    <if condition="$role_branch">
         $('#branch_id option[value="{$role_branch['branch_id']}"]').prop("selected", true);
         $('#branch_id').attr("readonly", "readonly");
         $('#branch_id').mousedown(function(){return false;});

    </if>
</script>

<include file="Public:newfieldvalid"/>
<if condition="ACTION_NAME == 'add'">
<script>
	$(function(){
		$("#category_id").formValidator({
			tipID:"category_idTip",
			onShow:"<span style='color:red;'>*必选项</span>",
			empty:false,
			onFocus:" ",
			onCorrect:"<span style='color:green;'>√</span>"
		}).inputValidator({
			min:1,max:255,
			onshow:"服务类别不能为空！",
			onErrorMin:"服务类别不能为空！",
			onErrorMax:""
		});
	});
</script>
</if>
<include file="Market:public_edit"/>
<script type="text/javascript">
    $("#owner_role_id").change();
	$("#category_id").change();
</script>
<include file="Public:footer" />